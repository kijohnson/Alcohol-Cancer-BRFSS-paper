---
title: "BRFSS alcohol consumption in cancer survivors vs. not survivors trend"
author: "Kim Johnson"
date: "`r Sys.Date()`"
output: html_document
---

# install packages and libraries
```{r}
pacman::p_load(haven, dplyr, table1, ggplot2, survey, broom, DiagrammeR, srvyr, patchwork, lmtest, VIM, mice, tidyr, purrr, readr, broom, stringr, writexl,readxl, purrr) 
```

# Load workspace
```{r}
load("R_output/BRFSS ALCOHOL TRENDS.RData")
```

## Importing the data from 2016 to 2023 that will be used for analyses
```{r chunk2}
# 2023
BRFSS_2023 <- read_xpt("../BRFSS data/Datasets/LLCP2023.XPT ", col_select = c("_STATE", SEXVAR, ALCDAY4, AVEDRNK3, DRNK3GE5, MAXDRNKS, CHCSCNC1, CHCOCNC1, "_LLCPWT", "_STSTR", "_PSU", CNCRTYP2, "_AGE_G", "_RFBING6", "_RFDRHV8", CSRVTRT3, "_RACEPRV", "_HLTHPL1", EDUCA, "_RFSMOK3", "MARITAL", "_INCOMG1", "PERSDOC3"))

BRFSS_2023 <- BRFSS_2023 %>% mutate(year = 2023)
BRFSS_2023.1 <- read_xpt("../BRFSS data/Datasets/LLCP23V1.XPT", col_select = c("_STATE", SEXVAR, ALCDAY4, AVEDRNK3, DRNK3GE5, MAXDRNKS, CHCSCNC1, CHCOCNC1, "_LLCPWT2", "_STSTR", "_PSU", CNCRTYP2,  "_AGE_G", "_RFBING6", "_RFDRHV8", CSRVTRT3, "_RACEPRV", "_HLTHPL1", EDUCA, "_RFSMOK3", , "MARITAL", "_INCOMG1", "PERSDOC3"))
BRFSS_2023.1 <- BRFSS_2023.1 %>% mutate(year = 2023)
BRFSS_2023.2 <- read_xpt("../BRFSS data/Datasets/LLCP23V2.XPT", col_select = c("_STATE", SEXVAR, ALCDAY4, AVEDRNK3, DRNK3GE5, MAXDRNKS, CHCSCNC1, CHCOCNC1, "_LLCPWT2", "_STSTR", "_PSU", CNCRTYP2, "_AGE_G", "_RFBING6", "_RFDRHV8", CSRVTRT3, "_RACEPRV", "_HLTHPL1", EDUCA, "_RFSMOK3", , "MARITAL", "_INCOMG1", "PERSDOC3"))
BRFSS_2023.2 <- BRFSS_2023.2 %>% mutate(year = 2023)
BRFSS_2023.3 <- read_xpt("../BRFSS data/Datasets/LLCP23V3.XPT", col_select = c("_STATE", SEXVAR, ALCDAY4, AVEDRNK3, DRNK3GE5, MAXDRNKS, CHCSCNC1, CHCOCNC1, "_LLCPWT2", "_STSTR", "_PSU", CNCRTYP2, "_AGE_G", "_RFBING6", "_RFDRHV8", CSRVTRT3, "_RACEPRV", "_HLTHPL1", EDUCA, "_RFSMOK3", , "MARITAL", "_INCOMG1", "PERSDOC3"))
BRFSS_2023.3 <- BRFSS_2023.3 %>% mutate(year = 2023)

# 2022
BRFSS_2022 <- read_xpt("../BRFSS data/Datasets/LLCP2022.XPT ", col_select = c("_STATE", SEXVAR, ALCDAY4, AVEDRNK3, DRNK3GE5, MAXDRNKS, CHCSCNC1, CHCOCNC1,  "_LLCPWT", "_STSTR", "_PSU", CNCRTYP2, "_AGE_G", "_RFBING6", "_RFDRHV8", CSRVTRT3, "_RACEPR1", "_HLTHPLN", EDUCA, "_RFSMOK3", , "MARITAL", "_INCOMG1", "PERSDOC3"))
BRFSS_2022 <- BRFSS_2022 %>% mutate(year = 2022)
BRFSS_2022.1 <- read_xpt("../BRFSS data/Datasets/LLCP22V1.XPT", col_select = c("_STATE", SEXVAR, ALCDAY4, AVEDRNK3, DRNK3GE5, MAXDRNKS, CHCSCNC1, CHCOCNC1,   "_LLCPWT2",, "_STSTR", "_PSU",  CNCRTYP2, "_AGE_G", "_RFBING6", "_RFDRHV8", CSRVTRT3, "_RACEPR1", "_HLTHPLN", EDUCA, "_RFSMOK3", , "MARITAL", "_INCOMG1", "PERSDOC3"))
 BRFSS_2022.1 <- BRFSS_2022.1 %>% mutate(year = 2022)
BRFSS_2022.2 <- read_xpt("../BRFSS data/Datasets/LLCP22V2.XPT", col_select = c("_STATE", SEXVAR, ALCDAY4, AVEDRNK3, DRNK3GE5, MAXDRNKS, CHCSCNC1, CHCOCNC1, "_LLCPWT2",, "_STSTR", "_PSU", CNCRTYP2, "_AGE_G", "_RFBING6", "_RFDRHV8", CSRVTRT3, "_RACEPR1", "_HLTHPLN", EDUCA, "_RFSMOK3", , "MARITAL", "_INCOMG1", "PERSDOC3"))
BRFSS_2022.2 <- BRFSS_2022.2 %>% mutate(year = 2022)
BRFSS_2022.3 <- read_xpt("../BRFSS data/Datasets/LLCP22V3.XPT", col_select = c("_STATE", SEXVAR, ALCDAY4, AVEDRNK3, DRNK3GE5, MAXDRNKS, CHCSCNC1, CHCOCNC1,   "_LLCPWT2",, "_STSTR", "_PSU", CNCRTYP2, "_AGE_G",  "_RFBING6", "_RFDRHV8", CSRVTRT3, "_RACEPR1", "_HLTHPLN", EDUCA, "_RFSMOK3", , "MARITAL", "_INCOMG1", "PERSDOC3"))
BRFSS_2022.3 <- BRFSS_2022.3 %>% mutate(year = 2022)

# 2021
BRFSS_2021 <- read_xpt("../BRFSS data/Datasets/LLCP2021.XPT ", col_select = c("_STATE", SEXVAR, ALCDAY5, AVEDRNK3, DRNK3GE5, MAXDRNKS, CHCOCNCR,  "_LLCPWT", "_STSTR", "_PSU", "_RFBING5", "_RFDRHV7", "_AGE_G", "_RACEPRV", "_HLTHPLN", EDUCA, "_RFSMOK3", "MARITAL", "_INCOMG1", "PERSDOC3"))
BRFSS_2021 <- BRFSS_2021 %>%
mutate(year = 2021)

# 2020
BRFSS_2020 <- read_xpt("../BRFSS data/Datasets/LLCP2020.XPT ", col_select = c("_STATE", SEXVAR, ALCDAY5, AVEDRNK3, DRNK3GE5, MAXDRNKS, CHCOCNCR,  "_LLCPWT", "_STSTR", "_PSU",  "_RFBING5", "_RFDRHV7", "_AGE_G", "_RACEPRV", HLTHPLN1, EDUCA, "_RFSMOK3", "MARITAL", "_INCOMG", "PERSDOC2"))
BRFSS_2020 <- BRFSS_2020 %>%
 mutate(year = 2020)

# 2019
BRFSS_2019 <- read_xpt("../BRFSS data/Datasets/LLCP2019.XPT ", col_select = c("_STATE", SEXVAR, ALCDAY5, AVEDRNK3, DRNK3GE5, MAXDRNKS, CHCOCNCR,  "_LLCPWT", "_STSTR", "_PSU",  "_RFBING5", "_RFDRHV7", "_AGE_G", "_RACE", HLTHPLN1, EDUCA, "_RFSMOK3", "MARITAL", "_INCOMG", "PERSDOC2"))
BRFSS_2019 <- BRFSS_2019 %>%
 mutate(year = 2019)

# 2018
BRFSS_2018 <- read_xpt("../BRFSS data/Datasets/LLCP2018.XPT ", col_select = c("_STATE", SEX1, ALCDAY5, AVEDRNK2, DRNK3GE5, MAXDRNKS, CHCOCNCR, "_LLCPWT", "_STSTR", "_PSU",  "_RFBING5", "_RFDRHV6", "_AGE_G", "_RACE", HLTHPLN1, EDUCA, "_RFSMOK3", "MARITAL", "_INCOMG","PERSDOC2"))
BRFSS_2018 <- BRFSS_2018 %>%
mutate(year = 2018)

# 2017
BRFSS_2017 <- read_xpt("../BRFSS data/Datasets/LLCP2017.XPT ", col_select = c("_STATE", SEX, ALCDAY5, AVEDRNK2, DRNK3GE5, MAXDRNKS, CHCOCNCR,  "_LLCPWT", "_STSTR", "_PSU",  "_RFBING5", "_RFDRHV5", "_AGE_G", "_RACE", HLTHPLN1, EDUCA, "_RFSMOK3", "MARITAL", "_INCOMG" ,"PERSDOC2"))
BRFSS_2017 <- BRFSS_2017 %>%
mutate(year = 2017)

# 2016
BRFSS_2016 <- read_xpt("../BRFSS data/Datasets/LLCP2016.XPT ", col_select = c("_STATE", SEX, ALCDAY5, AVEDRNK2, DRNK3GE5, MAXDRNKS, CHCOCNCR,  "_LLCPWT", "_STSTR", "_PSU",  "_RFBING5", "_RFDRHV5", "_AGE_G", "_RACE", HLTHPLN1, EDUCA,"_RFSMOK3", "MARITAL", "_INCOMG" ,"PERSDOC2", "DRNK3GE5"))
BRFSS_2016 <- BRFSS_2016 %>%
  mutate(year = 2016)
```


## Bind datasets together trend analysis (combine 2016 to 2023 data)
```{r}
BRFSS <- bind_rows(BRFSS_2016, BRFSS_2017, BRFSS_2018, BRFSS_2019, BRFSS_2020, BRFSS_2021, BRFSS_2022, BRFSS_2023)
```

## Data management/harmonization for trend analysis (using combined 2016 to 2023 data)
```{r}
# harmonize alcday5 and alcday4
BRFSS <- BRFSS %>%
  mutate(drinker30 = if_else(
    (year %in% c(2023, 2022) & ALCDAY4 == 888) | 
      (year %in% c(2016:2021) & ALCDAY5 == 888), 0,# no drinking
    if_else(
      (year %in% c(2023, 2022) & ALCDAY4 < 300) |
        (year %in% c(2016:2021) & ALCDAY5 < 300), 1, # at least one drink
      NA_real_  # Default value for "false" branch
    )
  ))

# make a numeric variable that will not be factored
BRFSS <- BRFSS %>%
  mutate(drinker30_numeric = drinker30)


# harmonize binge drinking
BRFSS <- BRFSS %>%
  mutate(binge = if_else(
    (year %in% c(2023, 2022) & `_RFBING6` == 1) |
      (year %in% c(2016:2021) & `_RFBING5` == 1),
    0,
    if_else(
      (year %in% c(2023, 2022) & `_RFBING6` == 2) |
      (year %in% c(2016:2021) & `_RFBING5` == 2),
      1,
      NA_real_
    )
  ))

# leave as numeric
BRFSS <- BRFSS %>%
  mutate(binge_numeric = binge)
# harmonize heavy drinking

BRFSS <- BRFSS %>%
  mutate(heavy = if_else(
    (year %in% c(2023, 2022) & `_RFDRHV8` == 1) |
    (year %in% c(2019:2021) & `_RFDRHV7` == 1)|
    (year == 2018 & `_RFDRHV6` == 1)|
    (year %in% c(2016:2017) & `_RFDRHV5` == 1),
    0,
    if_else(
      (year %in% c(2023, 2022) & `_RFDRHV8` == 2) |
      (year %in% c(2019:2021) & `_RFDRHV7` == 2)|
      (year == 2018 & `_RFDRHV6` == 2)|
      (year %in% c(2016:2017) & `_RFDRHV5` == 2),
      1,
      NA_real_
    )
  ))
# leave as numeric
BRFSS <- BRFSS %>%
  mutate(heavy_numeric = heavy)

# age category
BRFSS <- BRFSS %>%
  mutate(age_cat = case_when(`_AGE_G` == 1 ~ 0,
                             `_AGE_G` == 2 ~ 1,
                             `_AGE_G` == 3 ~ 2,
                             `_AGE_G` == 4 ~ 3,
                             `_AGE_G` == 5 ~ 4,
                             `_AGE_G` == 6 ~ 5))
BRFSS$age_cat <- factor(BRFSS$age_cat, levels = c(0:5), labels = c("18 to 24", "25 to 34", "35 to 44", "45 to 54", "55 to 64", "65+"))


# harmonize race/ethnicity
BRFSS <- BRFSS %>%
  mutate(race = case_when(
    year %in% c(2023, 2021, 2020) & `_RACEPRV` == 1 | year %in% c(2022) & `_RACEPR1` == 1| year %in% c(2016:2019) & `_RACE` == 1 ~ 0, # NHW
    year %in% c(2023, 2021, 2020) & `_RACEPRV` == 2 | year %in% c(2022) & `_RACEPR1` == 2| year %in% c(2016:2019) & `_RACE` == 2 ~ 1, # NHB
    year %in% c(2023, 2021, 2020) & `_RACEPRV` == 3 | year %in% c(2022) & `_RACEPR1` == 3| year %in% c(2016:2019) & `_RACE` == 3 ~ 2, # NHAIAN
    year %in% c(2023, 2021, 2020) & `_RACEPRV` == 4 | year %in% c(2022) & `_RACEPR1` == 4| year %in% c(2016:2019) & `_RACE` == 4 ~ 3, # NHASIAN
    year %in% c(2023, 2021, 2020) & `_RACEPRV` == 5 | year %in% c(2022) & `_RACEPR1` == 5| year %in% c(2016:2019) & `_RACE` == 5 ~ 4, # NHAPI
    year %in% c(2023, 2021, 2020) & `_RACEPRV` %in% c(6,7) | year %in% c(2022) & `_RACEPR1` == 6| year %in% c(2016:2019) & `_RACE` %in% c(6,7) ~ 5, #NHMULTI/OTHER
    year %in% c(2023, 2021, 2020) & `_RACEPRV`== 8 | year %in% c(2022) & `_RACEPR1` == 7| year %in% c(2016:2019) & `_RACE` == 8 ~ 6)) # Hispanic

table(BRFSS_2023$`_RACEPRV`)

# harmonize sex
BRFSS <- BRFSS %>%
  mutate(sex = case_when(
    year %in% c(2019:2023) & SEXVAR == 1 | year %in% c(2018) & SEX1 == 1| year %in% c(2016:2017) & SEX == 1 ~ 0, # male
    year %in% c(2019:2023) & SEXVAR == 2 | year %in% c(2018) & SEX1 == 2| year %in% c(2016:2017) & SEX == 2 ~ 1)) # female
table(BRFSS$sex)

# harmonize health plan
BRFSS <- BRFSS%>%
  mutate(
    insurance = if_else(
      (year == 2022 & `_HLTHPLN` == 1) | (year == 2023 & `_HLTHPL1` == 1)|(year == 2021 & `_HLTHPLN` == 1)|(year == 2020 & HLTHPLN1 == 1)|(year == 2019 & HLTHPLN1 == 1)
      |(year == 2018 & HLTHPLN1 == 1)|(year == 2017 & HLTHPLN1 == 1)|(year == 2016 & HLTHPLN1 == 1), 1,
      if_else(
        (year == 2022 & `_HLTHPLN` == 2) |
        (year == 2023 & `_HLTHPL1` == 2)|
        (year == 2021 & `_HLTHPLN` == 2)|
        (year == 2020 & HLTHPLN1 == 2)|
        (year == 2019 & HLTHPLN1 == 2)|
        (year == 2018 & HLTHPLN1 == 2)|
        (year == 2017 & HLTHPLN1 == 2)|
        (year == 2016 & HLTHPLN1 == 2), 0,
        NA_real_
      )
    )
  ) %>%
  
  # harmonize education
  mutate(educ = case_when(EDUCA %in% c(1,2,3) ~ 3,
                          EDUCA == 4 ~ 2,
                          EDUCA == 5 ~ 1,
                          EDUCA == 6 ~ 0)) %>%
  # current smoking
  mutate(smoke = case_when(`_RFSMOK3` == 1 ~ 0,
                           `_RFSMOK3` == 2 ~ 1)) %>%
  # marital status
  mutate(marital = case_when(MARITAL == 1 ~ 0,
                             MARITAL %in% c(2,3,4,5,6) ~ 1)) %>%
  
  # harmonize income
  mutate(income = case_when(
    (year %in% c(2016, 2017, 2018, 2019, 2020) & `_INCOMG` %in% c(1,2,3,4))|
    (year %in% c(2021, 2022, 2023) & `_INCOMG1` %in% c(1,2,3,4)) ~ 1,
    (year %in% c(2016, 2017, 2018, 2019, 2020) & `_INCOMG` == 5)|
    (year %in% c(2021, 2022, 2023) & `_INCOMG1` %in% c(5,6,7)) ~ 0 )) %>%
  
  # harmonize personal healthcare provider
  mutate(persdoc = case_when(
    (year %in% c(2016, 2017, 2018, 2019, 2020) & PERSDOC2 %in% c(1,2))|
    (year %in% c(2021, 2022, 2023) & PERSDOC3 %in% c(1,2)) ~ 1,
    (year %in% c(2016, 2017, 2018, 2019, 2020) & PERSDOC2 == 3)|
    (year %in% c(2021, 2022, 2023) & PERSDOC3 == 3) ~ 0))

# harmonize cancer survivor
BRFSS <- BRFSS %>%
  mutate(cancer_surv = if_else(
    (year %in% c(2023, 2022) & CHCOCNC1 == 1) |
      (year %in% c(2016:2021) & CHCOCNCR == 1),
    1,
    if_else(
      (year %in% c(2023, 2022) & CHCOCNC1 == 2 ) |
        (year %in% c(2016:2021) & CHCOCNCR ==2),
      0,
      NA_real_  # Default value for "false" branch
    )
  ))

# Factor variables
BRFSS$drinker30 <- factor(BRFSS$drinker30, levels = c(0,1), labels = c("No drinks", "At least one drink in last month"))
BRFSS$year <- factor(BRFSS$year, levels = c(2016:2023))
BRFSS$binge <- factor(BRFSS$binge, levels = c(0:1), labels = c("Not binge drinker", "Binge drinker"))
BRFSS$heavy <- factor(BRFSS$heavy, levels = c(0:1), labels = c("Not heavy drinker", "Heavy drinker"))
BRFSS$race <- factor(BRFSS$race, levels = c(0:6), labels = c("NH W", "NH B", "NH AIAN", "NH ASIAN", "NH API", "NH MULTI/OTHER", "HISPANIC"))
BRFSS$sex <- factor(BRFSS$sex, levels = c(0:1), labels = c("Male", "Female"))
BRFSS$insurance <- factor(BRFSS$insurance, levels= c(0:1), labels = c("No insurance", "Insurance"))
BRFSS$educ<- factor(BRFSS$educ, levels= c(0:3), labels = c("< High school", "High school", "Some college", "College or more"))
BRFSS$smoke<- factor(BRFSS$smoke, levels= c(0:1), labels = c("Non-smoker", "Current smoker"))
BRFSS$marital <- factor(BRFSS$marital, levels= c(0:1), labels = c("Married", "Unmarried"))
BRFSS$income <- factor(BRFSS$income, levels= c(0:1), labels = c("<50K", "50K+"))
BRFSS$persdoc <- factor(BRFSS$persdoc, levels= c(0:1), labels = c("No personal doctor", "personal doctor"))
BRFSS$cancer_surv <- factor(BRFSS$cancer_surv, levels = c(0:1), labels = c("No reported cancer", "Reported cancer"))

# rename state
BRFSS <- BRFSS %>%
  rename(state = `_STATE`)
```

## Pair down to variables for imputation
```{r}
BRFSS <- BRFSS %>%
  dplyr::select("cancer_surv", "drinker30", "age_cat", "race", "sex", "binge", "heavy", "insurance", "educ", "smoke", "marital", "income", "year", "_PSU", "_STSTR", "_LLCPWT", "persdoc", "state")
```

## Results Paragraph 1: Get amount of missing data by year in BRFSS for 2016 to 2023 data frames for paper
```{r}
# limit to questions everyone answered
data <- BRFSS %>%
   dplyr::select("cancer_surv", "drinker30", "age_cat", "race", "sex","insurance", "educ", "smoke", "marital", "income", "year", "persdoc", "state")
table(BRFSS$year)

data2 <- BRFSS %>%
   dplyr::select("cancer_surv", "drinker30", "age_cat", "race", "sex","insurance", "educ", "smoke", "marital", "income", "year", "persdoc", "state") %>%
  drop_na()

n_total <- nrow(data)
n_complete <- nrow(data2)
n_imputed_rows <- n_total - n_complete
n_imputed_rows
```
## Supplementary Table 1: Not R
## Supplementary Table 2: Not R
## Supplementary Table 3
```{r}
missing_summary <- sapply(BRFSS, function(x) sum(is.na(x))) %>%
  tibble::enframe(name = "variable", value = "n_missing") %>%
  mutate(percent_missing = round(100 * n_missing / nrow(data), 1)) %>%
  arrange(desc(n_missing))

# View the summary
missing_summary

# checks
table(data$year, useNA = "always")
table(data$income, useNA = "always")

# export
write_xlsx(missing_summary, path = "R_output/Supplementary Table 3 missing_data_summary 2016 to 2023.xlsx")
```

## Imputation for trend analysis from 2016 to 2023
- impute each year separately
```{r}
# # Get the unique years from the dataset
# years <- unique(BRFSS$year)
# 
# # Loop through each year
# for (year_value in years) {
#   # Subset the dataset for the current year
#   data <- subset(BRFSS, year == year_value)
# 
#   # Remove weighting variables that are not needed for imputation model
#   data_to_impute <- data[ , !(names(data) %in% c("_PSU", "_STSTR", "_LLCPWT"))]
# 
#   # Perform imputation
#   imp <- mice(data_to_impute, m = 1, maxit = 5, seed = 12345)
# 
#   # Get the completed dataset
#   completed_data <- complete(imp)
# 
#   # Reattach the weighting variables
#   completed_data <- cbind(completed_data, data[ , c("_PSU", "_STSTR", "_LLCPWT")])
# 
#   # Assign the completed dataset to a variable in the environment
#   assign(paste0("BRFSS_", year_value, "_imputed"), completed_data)
# }
```

## Merge all imputed dataframes back together for trend analysis
```{r}
# BRFSS_imputed <- rbind(BRFSS_2016_imputed, BRFSS_2017_imputed, BRFSS_2018_imputed, BRFSS_2019_imputed,BRFSS_2020_imputed, BRFSS_2021_imputed,BRFSS_2022_imputed, BRFSS_2023_imputed )
```

## Export data that will be used for trend analysis for import in subsequent session
```{r}
# saveRDS(BRFSS_imputed, file = "R_output/BRFSS_all_imputed_allyears.rds")
```

## Import BRFSS_imputed file for trend
```{r}
BRFSS_imputed  <- readRDS("R_output/BRFSS_all_imputed_allyears.rds")
```

## check binge drinking by year without post-imputation logic
```{r}
table1(~year|binge, BRFSS_imputed)
table1(~year|heavy, BRFSS_imputed)
```

## apply post-imputation logic
- specifically binge and heavy should be no for drinker30 since they were not asked if they said no
```{r}
table(BRFSS_imputed$drinker30, BRFSS_imputed$binge)
table(BRFSS_imputed$drinker30, BRFSS_imputed$heavy)

BRFSS_imputed <- BRFSS_imputed %>%
  mutate(binge = if_else(binge == "Binge drinker" & drinker30 == "No drinks", "Not binge drinker", binge))%>%
  mutate(heavy = if_else(heavy == "Heavy drinker" & drinker30 == "No drinks", "Not heavy drinker", heavy)) 

# refactor
BRFSS_imputed$binge <- factor(BRFSS_imputed$binge, levels= c("Not binge drinker", "Binge drinker"))
BRFSS_imputed$heavy <- factor(BRFSS_imputed$heavy, levels= c("Not heavy drinker", "Heavy drinker"))

table(BRFSS_imputed$drinker30, BRFSS_imputed$binge, useNA = "always")
table(BRFSS_imputed$drinker30, BRFSS_imputed$heavy)
```

## check binge drinking by year with post-imputation logic
```{r}
table1(~year|binge, BRFSS_imputed)
```

## What states are missing in each year? For paper methods paragraph 1
```{r}
table(BRFSS_imputed$state, BRFSS_imputed$year, useNA = "always")
length(unique(BRFSS_imputed$state))
# print(unique(BRFSS_imputed$state))

# missing data
# 12 2021 FLORIDA
# 21 2023 Kentucky
# 34 2019 New Jersey
# 42 2023 Pennsylvania
# 78 2017, 2018, 2019, 2020 Virgin Islands
```

# Create datasets with cancer type information for 2023 and 2022 association analysis
- need to use other datasets in addition to main since some states used alternative surveys
```{r}
# 2023
BRFSS_2023_limited <- BRFSS_2023 %>%
  filter(`_STATE` %in% c(9, 13, 17, 18, 26, 27, 28, 33, 34, 47, 78, 51, 54, 55)) %>%
  # rename weight variable
  rename(weight = "_LLCPWT")

BRFSS_2023_limited.1 <- BRFSS_2023.1 %>%
  filter(`_STATE` %in% c(36, 40)) %>%
  # rename weight variable
  rename(weight = "_LLCPWT2")


BRFSS_2023_limited.2 <- BRFSS_2023.2 %>%
  filter(`_STATE` %in% c(20,24)) %>%
  # rename weight variable
  rename(weight = "_LLCPWT2")

BRFSS_2023_limited <- bind_rows(BRFSS_2023_limited, BRFSS_2023_limited.1, BRFSS_2023_limited.2)

# 2022
BRFSS_2022_limited <- BRFSS_2022 %>%
  filter(`_STATE` %in% c(5, 8, 9, 10, 15, 16, 17, 18, 26, 29, 31, 32, 34, 35, 37, 41, 72, 44, 46, 49, 50, 51, 55)) %>%
  # rename weight variable
  rename(weight = "_LLCPWT")

BRFSS_2022_limited.1 <- BRFSS_2022.1 %>%
  filter(`_STATE` %in% c(19,25,39,40)) %>%
  # rename weight variable
  rename(weight = "_LLCPWT2")

BRFSS_2022_limited.2 <- BRFSS_2022.2 %>%
  filter(`_STATE` %in% c(4, 20))%>%
  # rename weight variable
  rename(weight = "_LLCPWT2")

BRFSS_2022_limited.3 <- BRFSS_2022.3 %>%
  filter(`_STATE` %in% c(24))%>%
  # rename weight variable
  rename(weight = "_LLCPWT2")

BRFSS_2022_limited <- bind_rows(BRFSS_2022_limited, BRFSS_2022_limited.1, BRFSS_2022_limited.2,  BRFSS_2022_limited.3)
```

# Bind BRFSS_2023_limited and BRFSS_2022_limited together for association analysis
```{r}
BRFSS_limited <- bind_rows(BRFSS_2023_limited, BRFSS_2022_limited)

BRFSS_limited <- BRFSS_limited %>%
  rename(strata = `_STSTR`) %>%
  rename(state = `_STATE`)

state_codes <- tibble::tibble(
  state = c(1, 2, 4, 5, 6, 8, 9, 10, 11, 12, 13, 15, 16, 17, 18, 19, 20, 21, 22,
            23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39,
            40, 41, 42, 44, 45, 46, 47, 48, 49, 50, 51, 53, 54, 55, 56, 66, 72, 78),
  state_abbrev = c("AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "DC", "FL", "GA", 
                   "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA",
                   "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY",
                   "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", 
                   "UT", "VT", "VA", "WA", "WV", "WI", "WY", "GU", "PR", "VI")
)
BRFSS_limited_labeled <- BRFSS_limited %>%
  left_join(state_codes, by = "state")

# check number of states
BRFSS_limited_states <- BRFSS_limited_labeled  %>%
  group_by(year)  %>%
  summarize(n = n_distinct(state_abbrev))

table(BRFSS_limited_labeled$state_abbrev, BRFSS_limited_labeled$year)
```


# 2023 and 2022 data management for association analyis prior to imputation
```{r}
table(cancer_surv = BRFSS_limited$CHCOCNC1, current_trt = BRFSS_limited$CSRVTRT3, useNA = "always")

# define cancer survivor
BRFSS_limited <- BRFSS_limited %>%
 mutate(cancer_surv = case_when(CHCOCNC1 == 1 ~ 1,
                             CHCOCNC1 == 2 ~ 0)) %>%
# define alcohol use
 mutate(drinker30 = case_when(ALCDAY4 == 888 ~ 0,
                              ALCDAY4 < 300 ~ 1))

table(cancer_surv = BRFSS_limited$cancer_surv, drinker30 = BRFSS_limited$drinker30 , useNA = "always")

table(BRFSS_limited$CHCOCNC1, BRFSS_limited$cancer_surv,  useNA = "always")

# leave as numeric
BRFSS_limited <- BRFSS_limited %>%
  mutate(drinker30_numeric = drinker30)
table(BRFSS_limited$CNCRTYP2)

# harmonize binge drinking
BRFSS_limited <- BRFSS_limited %>%
  mutate(binge = case_when( `_RFBING6` == 1 ~ 0,
                           `_RFBING6` == 2 ~ 1))

# leave as numeric
BRFSS_limited <- BRFSS_limited %>%
 mutate(binge_numeric = binge)

# # harmonize heavy drinking
BRFSS_limited <- BRFSS_limited %>%
mutate(heavy = case_when( `_RFDRHV8` == 1 ~ 0,
                           `_RFDRHV8` == 2 ~ 1))

# leave as numeric
BRFSS_limited <- BRFSS_limited %>%
   mutate(heavy_numeric = heavy)

# define cancer types
BRFSS_limited <- BRFSS_limited %>%
   mutate(can_type = case_when(cancer_surv == 0 ~ 0,
     cancer_surv == 1 &  CNCRTYP2 == 1 ~ 1,
     cancer_surv  == 1 & CNCRTYP2 == 2 ~ 2,
     cancer_surv  == 1 & CNCRTYP2 == 3 ~ 3,
     cancer_surv  == 1 &  CNCRTYP2 == 4 ~ 4,
     cancer_surv  == 1 &  CNCRTYP2 == 5 ~ 5,
     cancer_surv == 1 &  CNCRTYP2 == 6 ~ 6,
     cancer_surv == 1 & CNCRTYP2 == 7 ~ 7,
     cancer_surv == 1 & CNCRTYP2 == 8 ~ 8,
     cancer_surv == 1 &  CNCRTYP2 == 9 ~ 9,
     cancer_surv == 1 &   CNCRTYP2 == 10 ~ 10,
     cancer_surv == 1 &  CNCRTYP2 == 11 ~ 11,
     cancer_surv == 1 &  CNCRTYP2 == 12 ~ 12,
     cancer_surv == 1 &  CNCRTYP2 == 13 ~ 13,
     cancer_surv == 1 &  CNCRTYP2 == 14 ~ 14,
     cancer_surv == 1 &  CNCRTYP2 == 15 ~ 15,
     cancer_surv == 1 &   CNCRTYP2 == 16 ~ 16,
     cancer_surv == 1 &  CNCRTYP2 == 17 ~ 17,
     cancer_surv == 1 &  CNCRTYP2 == 18 ~ 18,
     cancer_surv == 1 &  CNCRTYP2 == 19 ~ 19,
     cancer_surv == 1 &  CNCRTYP2 == 20 ~ 20,
     cancer_surv == 1 &  CNCRTYP2 == 21 ~ 21,
     cancer_surv == 1 &   CNCRTYP2 == 22 ~ 22,
     cancer_surv == 1 &  CNCRTYP2 == 23 ~ 23,
     cancer_surv == 1 &  CNCRTYP2 == 24 ~ 24,
     cancer_surv == 1 &  CNCRTYP2 == 25 ~ 25,
     cancer_surv == 1 &  CNCRTYP2 == 26 ~ 26,
     cancer_surv == 1 &  CNCRTYP2 == 27 ~ 27,
     cancer_surv == 1 &  CNCRTYP2 == 28 ~ 28,
     cancer_surv == 1 &  CNCRTYP2 == 29 ~ 29,
    cancer_surv == 1 & CNCRTYP2 == 30 ~ 30,
    cancer_surv == 1 &  CNCRTYP2 == 77 ~ 31,
    cancer_surv == 1 &  CNCRTYP2 == 99 ~ 32,
    )) %>%
 mutate(age_cat = case_when(`_AGE_G` == 1 ~ 0,
                             `_AGE_G` == 2 ~ 1,
                            `_AGE_G` == 3 ~ 2,
                             `_AGE_G` == 4 ~ 3,
                             `_AGE_G` == 5 ~ 4,
                              `_AGE_G` == 6 ~ 5)) %>%

# currently receiving treatment for cancer
 mutate(current_trt = case_when(CSRVTRT3 ==  1 ~ 1,
                              CSRVTRT3 %in% c(2, 3, 4, 5) ~ 0)) %>%

 # define broader cancer types
 mutate(can_type2 = case_when(cancer_surv == 0 ~ 0,  # none
     cancer_surv == 1 &  CNCRTYP2 == 1 ~ 1,  # bladder
     cancer_surv  == 1 & CNCRTYP2 %in% c(2, 12, 15) ~ 2,  # Blood/hematologic
     cancer_surv  == 1 & CNCRTYP2 == 3 ~ 3,  # Bone
     cancer_surv  == 1 &  CNCRTYP2 == 4 ~ 4,  # Brain
     cancer_surv  == 1 &  CNCRTYP2 == 5 ~ 5,  # Breast
     cancer_surv == 1 &  CNCRTYP2 == 6 ~ 6,  # Cervix/cervical
     cancer_surv == 1 & CNCRTYP2 %in% c(7,21) ~ 7,  # Colon and rectal
     cancer_surv == 1 & CNCRTYP2 == 8 ~ 8,  # Esophagus/Esophageal
     cancer_surv == 1 &   CNCRTYP2 == 10 ~ 9,  # Kidney
     cancer_surv == 1 &  CNCRTYP2 == 13 ~ 10,  # Liver
     cancer_surv == 1 &  CNCRTYP2 == 14 ~ 11,  # Lung
     cancer_surv == 1 &   CNCRTYP2 == 16 ~ 12, # Melanoma
     cancer_surv == 1 &  CNCRTYP2 == 17 ~ 13,  # Mouth/tongue/lip
     cancer_surv == 1 &  CNCRTYP2 == 18 ~ 14,  # Ovary/Ovarian
     cancer_surv == 1 &  CNCRTYP2 == 19 ~ 15,  # Pancreas/Pancreatic
     cancer_surv == 1 &  CNCRTYP2 == 20 ~ 16,  # Prostate
     cancer_surv == 1 &   CNCRTYP2 %in% c(22,23)~ 17,  # Skin (non-melanoma)/Skin (don't know what kind)
     cancer_surv == 1 &  CNCRTYP2 == 25 ~ 18,  # Stomach
     cancer_surv == 1 &  CNCRTYP2 == 26 ~ 19, # Testis/Testicular
     cancer_surv == 1 &  CNCRTYP2 == 27 ~ 20,  # Throat-pharynx
     cancer_surv == 1 &  CNCRTYP2 == 28 ~ 21,  # Thyroid
     cancer_surv == 1 &  CNCRTYP2 == 29 ~ 22,  # Uterus/Uterine
     cancer_surv == 1 & CNCRTYP2 %in% c(9,11,24,30) ~ 23,  # Other,  Gallbladder,  Larynx-trachea,  Soft tissue (muscle or fat)
     cancer_surv == 1 &  CNCRTYP2 %in% c(77, 99) ~ 24  # Don't know/Not sure/Refused
     ))


# factor cancer type
 BRFSS_limited$can_type <- factor(
   BRFSS_limited$can_type,
   levels = c(0:32),
   labels = c("None", "Bladder", "Blood", "Bone", "Brain", "Breast",  "Cervix/Cervical",  "Colon", "Esophagus/Esophageal",  "Gallbladder", "Kidney",  "Larynx-trachea",  "Leukemia",
              "Liver", "Lung", "Lymphoma", "Melanoma", "Mouth/tongue/lip",  "Ovary/Ovarian",  "Pancreas/Pancreatic",  "Prostate", "Rectum/Rectal", "Skin (non-melanoma)",
              "Skin (don’t know what kind)", "Soft tissue (muscle or fat)", "Stomach", "Testis/Testicular", "Throat - pharynx", "Thyroid", "Uterus/Uterine",  "Other",  "Don’t know/Not sure",
              "Refused"))

# factor cancer type
 BRFSS_limited$can_type2 <- factor(BRFSS_limited$can_type2, levels = c(0:24),
   labels = c("None", "Bladder", "Hematologic", "Bone", "Brain", "Breast",  "Cervix/Cervical", "Colon and rectal",  "Esophagus/Esophageal", "Kidney",
  "Liver", "Lung", "Melanoma", "Mouth/tongue/lip",  "Ovary/Ovarian", "Pancreas/Pancreatic",  "Prostate", "Skin (non-melanoma)/Skin (don’t know what kind)","Stomach", "Testis/Testicular", "Throat - pharynx", "Thyroid", "Uterus/Uterine", "Other", "Don’t know/Not sure/Refused"))

 BRFSS_limited$age_cat <- factor(BRFSS_limited$age_cat, levels = c(0:5), labels = c("18 to 24", "25 to 34", "35 to 44", "45 to 54", "55 to 64", "65+"))
 table(BRFSS_limited$age_cat, useNA = "always")

 table(BRFSS_limited$can_type2)

  # harmonize race/ethnicity
 BRFSS_limited <- BRFSS_limited %>%
   mutate(race = case_when(year == 2023 & `_RACEPRV` == 1 | year== 2022 & `_RACEPR1` == 1 ~ 0,  # NHW
     year == 2023 & `_RACEPRV` == 2 | year == 2022 & `_RACEPR1` == 2 ~ 1,  # NHB
     year == 2023 & `_RACEPRV` == 3 | year == 2022 & `_RACEPR1` == 3 ~ 2,  # NHAIAN
     year == 2023 & `_RACEPRV` == 4 | year == 2022 & `_RACEPR1` == 4 ~ 3,  # NHASIAN
     year == 2023 & `_RACEPRV` == 5 | year == 2022 & `_RACEPR1` == 5 ~ 4,  # NHAPI
     year == 2023 & `_RACEPRV` %in% c(6,7) | year == 2022 & `_RACEPR1` == 6 ~ 5, # NHMULTI/OTHER
     year == 2023 & `_RACEPRV` == 8 | year == 2022 & `_RACEPR1` == 7 ~ 6)) %>%   # Hispanic

  # create collapsed race ethnicity variable for imputation because it causes errors due to sparseness of NHAPI category
   mutate(race_ethnicity = case_when(race %in% c(0, 1,2,3) ~ race,
                               race %in% c(4,5) ~ 4,
                               race == 6 ~ 5)) %>%

    # education
   mutate(educ = case_when(EDUCA %in% c(1,2,3) ~ 3,
                EDUCA == 4 ~ 2,
                EDUCA == 5 ~ 1,
                EDUCA == 6 ~ 0)) %>%
   # current smoking
  mutate(smoke = case_when(`_RFSMOK3` == 1 ~ 0,
                           `_RFSMOK3` == 2 ~ 1)) %>%
  # marital status
 mutate(marital = case_when(MARITAL == 1 ~ 0,
                            MARITAL %in% c(2,3,4,5,6) ~ 1)) %>%
  # income
 mutate(income = case_when(year %in% c( 2022, 2023) & `_INCOMG1` %in% c(1,2,3,4) ~ 1,
                           year %in% c(2022, 2023) & `_INCOMG1` %in% c(5,6,7) ~ 0 )) %>%
 # personal health care provider
 mutate(persdoc = case_when(year %in% c(2022, 2023) & PERSDOC3 %in% c(1,2) ~ 1,
                            year %in% c(2022, 2023) & PERSDOC3 == 3 ~ 0))

  # sex
 BRFSS_limited <- BRFSS_limited %>%
   mutate(sex = case_when(
     SEXVAR == 1 ~ 0,  # male
     SEXVAR == 2 ~ 1))  # female

 # factor variables
 BRFSS_limited$race <- factor(BRFSS_limited$race, levels = c(0:6), labels = c("NH W", "NH B", "NH AIAN", "NH ASIAN", "NH API", "NH MULTI/OTHER", "HISPANIC"))
 BRFSS_limited$race_ethnicity <- factor(BRFSS_limited$race_ethnicity, levels = c(0:5), labels = c("NH W", "NH B", "NH AIAN", "NH ASIAN", "NH API/MULTI/OTHER", "HISPANIC"))
 BRFSS_limited$sex <- factor(BRFSS_limited$sex, levels = c(0:1), labels = c("Male", "Female"))
 BRFSS_limited$current_trt <- factor(BRFSS_limited$current_trt, levels = c(0:1), labels = c("Not current treatment", "Current treatment"))
 BRFSS_limited$drinker30 <- factor(BRFSS_limited$drinker30, levels = c(0:1), labels = c("No drinks", "At least one drink in last month"))
 BRFSS_limited$cancer_surv <- factor(BRFSS_limited$cancer_surv, levels = c(0:1), labels = c("No reported cancer", "Reported cancer"))
 BRFSS_limited$binge <- factor(BRFSS_limited$binge, levels = c(0:1), labels = c("Not binge drinker", "Binge drinker"))
 BRFSS_limited$heavy <- factor(BRFSS_limited$heavy, levels = c(0:1), labels = c("Not heavy drinker", "Heavy drinker"))
 BRFSS_limited$educ<- factor(BRFSS_limited$educ, levels= c(0:3), labels = c("< High school", "High school", "Some college", "College or more"))
 BRFSS_limited$smoke<- factor(BRFSS_limited$smoke, levels= c(0:1), labels = c("Non-smoker", "Current smoker"))
 BRFSS_limited$marital <- factor(BRFSS_limited$marital, levels= c(0:1), labels = c("Married", "Unmarried"))
 BRFSS_limited$income <- factor(BRFSS_limited$income, levels= c(0:1), labels = c("<50K", "50K+"))
 BRFSS_limited$persdoc <- factor(BRFSS_limited$persdoc, levels= c(0:1), labels = c("No personal doctor", "personal doctor"))

# check
 table(BRFSS_limited$can_type)
 table(BRFSS_limited$current_trt, useNA = "always")
 table(BRFSS_limited$EDUCA)
 table(BRFSS_limited$`_HLTHPLN`)
 table (BRFSS_limited$`_HLTHPL1`)

# harmonize HLTHPLN and HLTHPL1
 BRFSS_limited <- BRFSS_limited %>%
   mutate(
     insurance = if_else(
       (year == 2022 & `_HLTHPLN` == 1) | (year == 2023 & `_HLTHPL1` == 1), 1,
       if_else(
         (year == 2022 & `_HLTHPLN` == 2) | (year == 2023 & `_HLTHPL1` == 2), 0,
         NA_real_
       )
     )
   )

# factor insurance
 BRFSS_limited$insurance <- factor(BRFSS_limited$insurance, levels= c(0:1), labels = c("No insurance", "Insurance"))
```

# adjust weights to account for two years 2022 and 2023 (per method described in Complex-Sampling-Weights-and-Preparing-Module-Data-for-Analysis-2023-508, https://www.cdc.gov/brfss/annual_data/2023/pdf/Complex-Sampling-Weights-and-Preparing-Module-Data-for-Analysis-2023-508.pdf)
```{r}
# find proportion in each year
table(BRFSS_limited$year)

year_proportions <- BRFSS_limited %>%
  group_by(year) %>%
  summarise(count = n()) %>%
  mutate(proportion = count / sum(count))

BRFSS_limited <- BRFSS_limited %>%
  group_by(year) %>%
  mutate(adj_weight = case_when(year == 2022 ~ 0.6089046*weight,
                                year == 2023 ~ 0.3910954*weight))
```

# limit data to variables needed for 2022 and 2023 association analysis prior to imputation
```{r}
BRFSS_limited2 <- BRFSS_limited %>%
  mutate(id = row_number()) %>%
  dplyr::select("id", "cancer_surv", "can_type2", "drinker30",   "current_trt",  "age_cat",  "race_ethnicity", "sex", "binge", "heavy", "insurance", "educ", "smoke", "marital", "income", "year", "_PSU", "strata", "adj_weight", "persdoc", "state")
```

# examine missingness using md.pattern
```{r}
# examine cancer variables
df <- BRFSS_limited2 %>%
  select("cancer_surv", "can_type2","current_trt")

md.pattern(df, rotate.names = TRUE)
```

# Results paragraph 1: find total number of rows with imputed data 
```{r}
# limit to questions everyone got
data <- BRFSS_limited2 %>%
  dplyr::select("id", "drinker30",  "age_cat",  "race_ethnicity", "sex", "insurance", "educ", "smoke", "marital", "income", "year", "persdoc", "state")

data2 <- BRFSS_limited2 %>%
  dplyr::select("id", "drinker30",  "age_cat",  "race_ethnicity", "sex", "insurance", "educ", "smoke", "marital", "income", "year", "persdoc", "state") %>%
  drop_na()

n_total <- nrow(data)
n_complete <- nrow(data2)
n_imputed_rows <- n_total - n_complete

# confirm by dropping one at a time

data_ex1 <- data %>%
  drop_na(drinker30)
ex1 <- nrow(data) - nrow(data_ex1)

data_ex2 <- data_ex1 %>%
  drop_na(age_cat)
ex2 <- nrow(data_ex1) - nrow(data_ex2)

data_ex3 <- data_ex2 %>%
  drop_na(race_ethnicity)
ex3 <- nrow(data_ex2) - nrow(data_ex3)

data_ex4 <-  data_ex3 %>%
  drop_na(sex)
ex4 <- nrow(data_ex3) - nrow(data_ex4)

data_ex5 <- data_ex4 %>%
  drop_na(insurance)
ex5 <- nrow(data_ex4) - nrow(data_ex5)

data_ex6 <-  data_ex5 %>%
  drop_na(educ)
ex6 <- nrow(data_ex5) - nrow(data_ex6)

data_ex7 <-  data_ex6 %>%
  drop_na(smoke)
ex7 <- nrow(data_ex6) - nrow(data_ex7)

data_ex8 <-  data_ex7 %>%
  drop_na(marital)
ex8 <- nrow(data_ex7) - nrow(data_ex8)

data_ex9 <-  data_ex8 %>%
  drop_na(income)
ex9 <- nrow(data_ex9) - nrow(data_ex8)

data_ex10 <-  data_ex9 %>%
  drop_na(year)
ex10 <- nrow(data_ex9) - nrow(data_ex10)

data_ex11 <-  data_ex10 %>%
  drop_na(persdoc)
ex11 <- nrow(data_ex10) - nrow(data_ex11)
```

# Results Paragraph 1, get total number of observations with missing data
```{r}
# number of obs missing data
count <- nrow(data) - nrow(data_ex11)

percent <- 1- (nrow(data_ex11)/nrow(data))

count
percent
```


# Supplementary Table 3: amount of missing data per year for each variable 2022 and 2023 for paper
```{r}
missing_summary <- sapply(BRFSS_limited2, function(x) sum(is.na(x))) %>%
  tibble::enframe(name = "variable", value = "n_missing") %>%
  mutate(percent_missing = round(100*n_missing / nrow(BRFSS_limited2), 1)) %>%
  arrange(desc(n_missing))

# View the summary
missing_summary

# checks
table(data$year, useNA = "always")
table(data$income, useNA = "always")

# export
write_xlsx(missing_summary, path = "R_output/Supplementary Table 3 missing_data_summary 2022 to 2023.xlsx")
```

# Imputation for 2022 to 2023 data
```{r}
# # Define the years you want to process
# years <- c(2022, 2023)
# 
# # Initialize a list to hold imputed datasets
# all_imputed_data <- list()
# 
# for (year_value in years) {
#   message("Running imputations for year: ", year_value)
# 
#   # Subset data for the current year
#   data <- subset(BRFSS_limited2, year == year_value)
#   data_to_impute <- data[ , !(names(data) %in% c("_PSU", "strata", "adj_weight"))]
# 
#   # Define method and predictor matrix
#   meth <- make.method(data_to_impute)
#   pred <- make.predictorMatrix(data_to_impute)
# 
#   # Remove problematic predictors
#   pred[, c("cancer_surv", "can_type2")] <- 0
# 
#   # Run 5 imputations
#   imp <- mice(data_to_impute, method = meth, predictorMatrix = pred,
#               m = 5, maxit = 5, seed = 12345, print = TRUE)
# 
#   # Print logged events (optional)
#   print(imp$loggedEvents)
# 
#   # Extract and store each imputed dataset
#   for (i in 1:5) {
#     completed <- complete(imp, i)
# 
# 
# 
#     # Add back weights and year
#     completed <- cbind(completed, data[, c("_PSU", "strata", "adj_weight")])
#     completed$year <- year_value
# 
#     # Store in list with name like "2022_1", "2022_2", etc.
#     list_name <- paste0(year_value, "_", i)
#     all_imputed_data[[list_name]] <- completed
#   }
# }
```

# export for analysis
```{r}
# saveRDS(all_imputed_data, file = "R_output/BRFSS_all_imputed_data 2022 2023.rds")
```


# import 2022 2023 data for analysis
```{r}
all_imputed_data3 <- readRDS("R_output/BRFSS_all_imputed_data 2022 2023.rds")
```

# check included states for methods paragraph 1
```{r}
df <- all_imputed_data3[[1]]
table(df$state, df$year)

table(df$year)
table(df$state)
```


# check for wrong cancer types in males and females
```{r}
check <- all_imputed_data4[[1]] %>%
  group_by(sex, cancer_surv, can_type2) %>%
  count(name = "n")
```


# Apply post-imputation logic to several variables and define alcohol-related cancers
```{r}
# Define the cleaned list
all_imputed_data4 <- lapply(all_imputed_data3, function(df) {
  df %>%
    
    # drinking  and current treatment variables
    # logic for current_trt. If they have not reported a cancer or if it was imputed as "No reported cancer, they cannot be in current treatment
    # logic for binge and heavy--these questions were not asked if drinker30 is no drinks so they should be assigned as not binge drinker and not heavy drinker
  mutate(
        current_trt = if_else( 
        cancer_surv == "No reported cancer",
        "Not current treatment", 
        current_trt),
     
       binge = if_else(
        drinker30 == "No drinks",
        "Not binge drinker",
        binge),

       heavy = if_else(
        drinker30 == "No drinks",
        "Not heavy drinker",
        heavy
        )) %>%
    
    # Fix can_type2 for individuals with "No reported cancer" and for impossible cancer types based on sex.
    mutate(
      can_type2 = if_else(
        cancer_surv == "No reported cancer",
        "None",
        can_type2
        )) %>%
 
      
    # correct impossible cancer types by sex
    mutate(
      can_type2 = case_when(
        sex == "Male" & can_type2 %in% c("Cervix/Cervical", "Uterus/Uterine", "Ovary/Ovarian") ~ "None",
        sex == "Female" & can_type2 %in% c("Prostate", "Testis/Testicular") ~ "None",
        TRUE ~ can_type2
      )) %>%
    
    
    # Convert to factors
    mutate(
      
      current_trt = factor(current_trt, levels = c(
        "Not current treatment", "Current treatment"
      )),
      binge = factor(binge, levels = c(
        "Not binge drinker", "Binge drinker"
      )),
      heavy = factor(heavy, levels = c(
        "Not heavy drinker", "Heavy drinker"
      ))
    )
})

 # fix can_type2 for individuals with reported cancer who were imputed as none
 all_imputed_data4 <- lapply(all_imputed_data4, function(df) {
  df %>%
    
    mutate(
      can_type2 = if_else(
        cancer_surv == "Reported cancer" & can_type2 == "None",
        "Other",
        as.character(can_type2)  # ensure it's character before reassignment
      )
    ) %>%
    
    mutate(
      can_type2 = factor(can_type2, levels = c(
        "None", "Bladder", "Hematologic", "Bone", "Brain", "Breast",  
        "Cervix/Cervical", "Colon and rectal",  "Esophagus/Esophageal", "Kidney",
        "Liver", "Lung", "Melanoma", "Mouth/tongue/lip",  "Ovary/Ovarian", "Pancreas/Pancreatic",  
        "Prostate", "Skin (non-melanoma)/Skin (don’t know what kind)", "Stomach", "Testis/Testicular", 
        "Throat - pharynx", "Thyroid", "Uterus/Uterine", "Other", "Don’t know/Not sure/Refused"
      ))
    ) %>%
    
    mutate(
      alcohol_related2 = case_when(
        as.character(can_type2) == "None" ~ 0,
        as.character(can_type2) %in% c("Breast", "Colon", "Esophagus/Esophageal", "Liver", "Larynx-trachea", "Throat - pharynx", "Mouth/tongue/lip", "Rectum/Rectal") ~ 1,
        TRUE ~ 2
      )
    ) %>%
    mutate(
  alcohol_related2 = factor(alcohol_related2, levels = c(0, 1, 2),
    labels = c("No cancer history", "Alcohol related", "Not alcohol related"))
)
})
```

# Check
```{r}
df <- all_imputed_data4[[1]] %>%
  filter(sex == "Male", cancer_surv == "Reported cancer")

table(df$can_type2, useNA = "always")
```


# Table 1 for trend analysis (based on single dataframe because only one imputation was performed)
```{r}
label(BRFSS_imputed$cancer_surv) <- "Reported cancer history"
label(BRFSS_imputed$drinker30) <- "At least one drink in last 30 days"
label(BRFSS_imputed$age_cat) <- "Age category"
label(BRFSS_imputed$race) <- "Race category"
label(BRFSS_imputed$sex) <- "Sex"
label(BRFSS_imputed$binge) <- "Binge drinking"
label(BRFSS_imputed$heavy) <- "Heavy drinking"
label(BRFSS_imputed$insurance) <- "Insurance"
label(BRFSS_imputed$educ) <- "Education"
label(BRFSS_imputed$smoke) <- "Current smoker"
label(BRFSS_imputed$marital) <- "Marital status"
label(BRFSS_imputed$income) <- "Income category"
label(BRFSS_imputed$persdoc) <- "Personal doctor"

table1(~age_cat + race + sex + insurance + educ + marital + income + persdoc + smoke + drinker30 + heavy + binge |cancer_surv, BRFSS_imputed)
```


# Combine 2022 and 2023 data to make 5 imputed datasets instead of 10 (1 x 5 for each year)
```{r}
# All_imputed_data3[1:5] are from 2022 and [6:10] are from 2023
combined_imputed_data <- map2(all_imputed_data4[1:5], all_imputed_data4[6:10], bind_rows)

# correct list names
names(combined_imputed_data) <- paste0("2022_2023_", seq_along(combined_imputed_data))

# check
df1 <- combined_imputed_data[[1]]
table(df1$year)
df2 <- combined_imputed_data[[2]]
table(df2$year)

# of obs in original is as below
```


# Create table 1 through pooling for 2022 and 2023 data
```{r}
# Define variables to summarize
vars <- c("age_cat", "race_ethnicity", "sex", "insurance", "educ", "marital", "income", "persdoc", "smoke", "drinker30", "heavy", "binge", "alcohol_related2", "can_type2")

# Function to summarize by group (stratified)
summarize_dataset <- function(data, group_var, vars) {
  data %>%
    select(all_of(c(group_var, vars))) %>%
    pivot_longer(cols = all_of(vars), names_to = "Variable", values_to = "Value") %>%
    group_by(!!sym(group_var), Variable, Value) %>%
    summarise(n = n(), .groups = "drop") %>%
    group_by(Variable, !!sym(group_var)) %>%
    mutate(prop = n / sum(n)) %>%
    ungroup()
}

# Function to summarize overall (no stratification)
summarize_overall <- function(data, vars) {
  data %>%
    select(all_of(vars)) %>%
    pivot_longer(cols = all_of(vars), names_to = "Variable", values_to = "Value") %>%
    group_by(Variable, Value) %>%
    summarise(n = n(), .groups = "drop") %>%
    group_by(Variable) %>%
    mutate(prop = n / sum(n)) %>%
    ungroup()
}

# Stratified summaries for all imputations
all_summaries_strat <- lapply(combined_imputed_data, summarize_dataset, group_var = "cancer_surv", vars = vars)

# Overall summaries for all imputations
all_summaries_overall <- lapply(combined_imputed_data, summarize_overall, vars = vars)

# Pool stratified
pooled_strat <- bind_rows(all_summaries_strat) %>%
  group_by(cancer_surv, Variable, Value) %>%
  summarise(mean_n = mean(n), mean_prop = mean(prop), .groups = "drop")

# Pool overall
pooled_overall <- bind_rows(all_summaries_overall) %>%
  group_by(Variable, Value) %>%
  summarise(mean_n = mean(n), mean_prop = mean(prop), .groups = "drop") %>%
  mutate(cancer_surv = "Overall")

# Combine both
pooled_combined <- bind_rows(pooled_strat, pooled_overall) %>%
  mutate(
    display = paste0(round(mean_n), " (", round(mean_prop * 100, 1), "%)")
  )

# Pivot wider to form Table 1
table1_pooled <- pooled_combined %>%
  select(Variable, Value, cancer_surv, display) %>%
  pivot_wider(names_from = cancer_surv, values_from = display, values_fill = "0 (0%)") %>%
  arrange(Variable, Value)

# View result
print(table1_pooled, n = Inf)

# Write to CSV
write.csv(table1_pooled, "R_output/table1_pooled_2022_2023_with_overall.csv", row.names = FALSE)
```

# function for unweighted prevalences
```{r}
survey_unweighted_prevalence <- function(data, var, levels_map, title_text, filename) {
# Set the level of interest (the one you want prevalence of)
  level_of_interest <- levels_map[1]
  level_reference <- levels_map[2]
  num_var <- paste0(var, "_numeric")

  # Create numeric variable: 1 = level_of_interest, 0 = reference
  data <- data %>%
    mutate(
      !!num_var := case_when(
        .data[[var]] == level_of_interest ~ 1,
        .data[[var]] == level_reference ~ 0,
        TRUE ~ NA_real_
      )
    )

  # Print a check table and info message
  message("Calculating prevalence of: '", level_of_interest, "'")
  print(table(data[[num_var]], useNA = "ifany"))

  # Calculate unweighted prevalence
  summary_df <- data %>%
    group_by(year, cancer_surv) %>%
    summarise(prevalence = mean(.data[[num_var]], na.rm = TRUE) * 100, 
              n = sum(!is.na(.data[[num_var]])),
              p = mean(.data[[num_var]], na.rm = TRUE),
              se = sqrt(p * (1 - p) / n),
              ci_lower = (p - 1.96 * se) * 100, # calculated using Wald approximation
              ci_upper = (p + 1.96 * se) * 100,
              .groups = "drop")

  # Create plot
  plot <- ggplot(summary_df, aes(x = year, y = prevalence, color = cancer_surv)) +
  geom_point(size = 3) +
  geom_line(aes(group = cancer_surv), linewidth = 1) +
  scale_color_manual(values = c("blue", "black")) +
  labs(
    title = title_text,
    x = "Year",
    y = paste0("Prevalence of ", level_of_interest, " (%)"),
    color = "Cancer Survivor Status"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(hjust = 0, size = 16, face = "bold"),  # left-justified title "A"
    axis.text = element_text(size = 11),
    axis.title = element_text(size = 12),
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10)
  ) +
  ylim(0, 100)

# Save plot if filename is provided
  if (!is.null(filename)) {
    ggsave(filename, plot = plot, device = "pdf", width = 8, height = 6)
  }

  # Return both the plot and the summary data
  return(list(plot = plot, prevalence_data = summary_df))
}
```


# run unweighted prevalence function
```{r}
# Prevalence of any drinking
drinker30 <-survey_unweighted_prevalence(
  data = BRFSS_imputed,
  var = "drinker30",
  levels_map = c("At least one drink in last month", "No drinks"),
  title_text = "A",
  filename = "R_output/unweighted_plot_imputed.pdf"
)

# Access the prevalence data
drinker30_prevalence_df <- drinker30$prevalence_data

# Prevalence of binge drinking
binge<- survey_unweighted_prevalence(
  data = BRFSS_imputed,
  var = "binge",
  levels_map = c("Binge drinker", "Not binge drinker"),
  title_text = "Prevalence of Binge Drinking \n by Year and Cancer Survivor Status",
  filename = "R_output/bingeplot_unweighted_imputed.pdf"
)

binge

# Access the prevalence data
binge_prevalence_df <- binge$prevalence_data

# Prevalence of heavy drinking
heavy <- survey_unweighted_prevalence(
  data = BRFSS_imputed,
  var = "heavy",
  levels_map = c("Heavy drinker", "Not heavy drinker"),
  title_text = "Prevalence of Heavy Drinking \n by Year and Cancer Survivor Status",
  filename = "R_output/heavyplot_unweighted_imputed.pdf"
)
heavy
# Access the prevalence data
heavy_prevalence_df <- heavy$prevalence_data
```

# Get unweighted prevalence data
```{r}
drinker30_unweighted_prevalence <- drinker30$prevalence_data
drinker30_unweighted_prevalence$unweighted <- "drinker30_unweighted"
drinker30_unweighted_prevalence <- drinker30_unweighted_prevalence %>%
rename(year2 = year, cancer_surv2 = cancer_surv)

binge_unweighted_prevalence <- binge$prevalence_data
binge_unweighted_prevalence$unweighted <- "binge_unweighted"

binge_unweighted_prevalence <- binge_unweighted_prevalence %>%
rename(year2 = year,cancer_surv2 = cancer_surv)

heavy_unweighted_prevalence <- heavy$prevalence_data
heavy_unweighted_prevalence$unweighted <- "heavy_unweighted"

heavy_unweighted_prevalence <- heavy_unweighted_prevalence %>%
rename(year2 = year, cancer_surv2 = cancer_surv)
```

# Function to calculate weighted prevalences for drinker30, binge, and heavy
```{r}
survey_weighted_prevalence <- function(
  data,
  variable,                # Name of the variable (e.g., "drinker30")
  level_of_interest,       # The level you want the prevalence of
  years = 2016:2023,
  colors = c("blue", "black"),
  label = NULL
) {
  options(survey.lonely.psu = "adjust")
  result_list <- list()

  for (yr in years) {
    df_year <- data %>%
      filter(year == yr) %>%
      mutate(
        cancer_surv = factor(cancer_surv, levels = c("No reported cancer", "Reported cancer")),
        outcome_binary = case_when(
          .data[[variable]] == level_of_interest ~ 1,
          !is.na(.data[[variable]]) ~ 0,
          TRUE ~ NA_real_
        )
      )

    design <- svydesign(
      id = ~1,
      strata = ~`_STSTR`,
      weights = ~`_LLCPWT`,
      data = df_year
    )

    # calculate prevalence
    prevalence <- svyby(
      ~outcome_binary,
      ~cancer_surv,
      design = design,
      FUN = svymean,
      na.rm = TRUE
    )

    prevalence$year <- yr
    result_list[[as.character(yr)]] <- prevalence
  }

  combined <- bind_rows(result_list)
  print(names(combined))

combined <- combined %>%
  mutate(
    percent = outcome_binary * 100,
    lowCI = percent - 1.96 * se * 100,
    highCI = percent + 1.96 * se * 100
  )
  # Plot
  plot <- ggplot(combined, aes(x = year, y = percent, color = cancer_surv)) +
    geom_point(size = 1) +
    geom_line(aes(group = cancer_surv), linewidth = 1) +
    geom_errorbar(aes(ymin = lowCI, ymax = highCI), width = 0.05) +
    scale_color_manual(values = colors) +
    labs(
      title = label,
      x = "Year",
      y = paste0("Prevalence (%)"),
      color = "Cancer Survivor Status"
    ) +
    ylim(0, 60) +
    theme_classic() +
    theme(
      plot.title = element_text(hjust = 0, size = 14, face = "bold"),
      axis.text = element_text(size = 12),
      axis.title = element_text(size = 14),
      legend.title = element_text(size = 12),
      legend.text = element_text(size = 10)
    )

  return(list(data = combined, plot = plot))
}

```


# run weighted prevalence function
```{r}
result_drinker30 <- survey_weighted_prevalence(
  data = BRFSS_imputed, variable = "drinker30", level_of_interest = "At least one drink in last month", label = "A")

result_heavy <- survey_weighted_prevalence(BRFSS_imputed, variable = "heavy", level_of_interest = "Heavy drinker", label = "B")

result_binge <- survey_weighted_prevalence(BRFSS_imputed, variable = "binge", level_of_interest = "Binge drinker", label = "C")

# Combine plots into one figure
combined_plot <- result_drinker30$plot + result_heavy$plot + result_binge$plot +
  plot_layout(ncol = 1, guides = "collect")
combined_plot
# Save to PDF
ggsave("R_output/Figure 1.pdf", plot = combined_plot, width = 11, height = 8.5, units = "in")


# export data
# Create a named list of dataframes for export
prevalence_sheets <- list(
  "Current_Drinker" = result_drinker30$data,
  "Binge_Drinker" = result_binge$data,
  "Heavy_Drinker" = result_heavy$data
)


# Export to Excel with each list element as a separate sheet
write_xlsx(prevalence_sheets, path = "R_output/alcohol_prevalence_data.xlsx")
```

# Import prevalences for trend analysis
```{r}
# Set path to your file (adjust as needed)
file_path <- "R_output/prevalence_results.xlsx"

# Import each sheet
drinker30_weighted <- read_excel(file_path, sheet = "Current_Drinker")
drinker30_weighted$weighted <- "drinker30_weighted"
binge_weighted   <- read_excel(file_path, sheet = "Binge_Drinker")
binge_weighted$weighted <- "binge_weighted"
heavy_weighted <- read_excel(file_path, sheet = "Heavy_Drinker")
heavy_weighted$weighted <- "heavy_weighted"
```

# Add unweighted prevalences to weighted prevalences
```{r}
# drinker30
colnames(drinker30_weighted) <- paste0(colnames(drinker30_weighted), "_w")
colnames(drinker30_unweighted_prevalence) <- paste0(colnames(drinker30_unweighted_prevalence), "_u")

drinker30 <- bind_cols(drinker30_weighted, drinker30_unweighted_prevalence)

drinker30 <- drinker30 %>% 
  select(-c("cancer_surv2_u", "year2_u", "outcome_binary_w", "se_w")) %>%
  rename(weighted = percent_w,
         unweighted = prevalence_u) %>%
  select(-c("weighted_w", "unweighted_u", "n_u", "p_u", "se_u"))  %>%
  mutate(
    prevalence_ci_w = sprintf("%.1f%% (%.1f to %.1f)", weighted, lowCI_w, highCI_w),
    prevalence_ci_u = sprintf("%.1f%% (%.1f to %.1f)", unweighted, ci_lower_u, ci_upper_u)) %>%
  select(1:2, 9:10)

# heavy
colnames(heavy_weighted) <- paste0(colnames(heavy_weighted), "_w")
colnames(heavy_unweighted_prevalence) <- paste0(colnames(heavy_unweighted_prevalence), "_u")

heavy <- bind_cols(heavy_weighted, heavy_unweighted_prevalence)

heavy <- heavy %>% 
  select(-c("cancer_surv2_u", "year2_u", "outcome_binary_w", "se_w")) %>%
  rename(weighted = percent_w,
         unweighted = prevalence_u) %>%
  select(-c("weighted_w", "unweighted_u", "n_u", "p_u", "se_u"))  %>%
  mutate(
    prevalence_ci_w = sprintf("%.1f%% (%.1f to %.1f)", weighted, lowCI_w, highCI_w),
    prevalence_ci_u = sprintf("%.1f%% (%.1f to %.1f)", unweighted, ci_lower_u, ci_upper_u)) %>%
  select(1:2, 9:10)

# binge
colnames(binge_weighted) <- paste0(colnames(binge_weighted), "_w")
colnames(binge_unweighted_prevalence) <- paste0(colnames(binge_unweighted_prevalence), "_u")

binge <- bind_cols(binge_weighted, binge_unweighted_prevalence)

binge <- binge %>% 
  select(-c("cancer_surv2_u", "year2_u", "outcome_binary_w", "se_w")) %>%
  rename(weighted = percent_w,
         unweighted = prevalence_u) %>%
  select(-c("weighted_w", "unweighted_u", "n_u", "p_u", "se_u"))  %>%
  mutate(
    prevalence_ci_w = sprintf("%.1f%% (%.1f to %.1f)", weighted, lowCI_w, highCI_w),
    prevalence_ci_u = sprintf("%.1f%% (%.1f to %.1f)", unweighted, ci_lower_u, ci_upper_u)) %>%
  select(1:2, 9:10)
```

# Supplementary Table 5: Weighted and unweighted prevalences
```{r}
write_xlsx(
  list(
    Drinker30 = drinker30,
    Heavy = heavy,
    Binge = binge
  ),
  path = "R_output/Supplementary Table 5.xlsx"
)
```

# run linear and log linear models to get percentage point change and apc
```{r}
# drinkder 30
# No cancer history
# linear model
model1 <- lm(percent ~ year, data = current_drinker %>% filter(cancer_surv == "No reported cancer"))
summary(model1)

# log linear for APC
model2 <- lm(log(percent) ~ year, data = current_drinker %>% filter(cancer_surv == "No reported cancer"))
summary(model2)

APC <- (exp(-0.004898) - 1) * 100
APC

# cancer history
# linear model
model3 <- lm(percent ~ year, data = current_drinker %>% filter(cancer_surv == "Reported cancer"))
summary(model3)

# log linear for APC
model4 <- lm(log(percent) ~ year, data = current_drinker %>% filter(cancer_surv == "Reported cancer"))
summary(model4)

APC <- (exp(0.002655) - 1) * 100
APC

# heavy
# No cancer history
# linear model
model1a <- lm(percent ~ year, data = heavy_drinker %>% filter(cancer_surv == "No reported cancer"))
summary(model1a)

# log linear for APC
model2a <- lm(log(percent) ~ year, data = heavy_drinker %>% filter(cancer_surv == "No reported cancer"))
summary(model2a)


# cancer survivors
# linear model
model3a <- lm(percent ~ year, data = heavy_drinker %>% filter(cancer_surv == "Reported cancer"))
summary(model3a)

# log linear for APC
model4a <- lm(log(percent) ~ year, data = heavy_drinker %>% filter(cancer_surv == "Reported cancer"))
summary(model4a)


# binge
# No cancer history
# linear model
model1b <- lm(percent ~ year, data = binge_drinker %>% filter(cancer_surv == "No reported cancer"))
summary(model1b)

# log linear for APC
model2b <- lm(log(percent) ~ year, data = binge_drinker %>% filter(cancer_surv == "No reported cancer"))
summary(model2b)


# cancer history
# linear model
model3b <- lm(percent ~ year, data = binge_drinker %>% filter(cancer_surv == "Reported cancer"))
summary(model3b)

# log linear for APC
model4b <- lm(log(percent) ~ year, data = binge_drinker %>% filter(cancer_surv == "Reported cancer"))
summary(model4b)

```

# Logistic models for 2022 to 2023 data 
- Setup survey design 
```{r}
options(survey.lonely.psu = "adjust")

survey_designs <- lapply(combined_imputed_data, function(df) {
  svydesign(id = ~`_PSU`,
            strata = ~strata,
            weights = ~adj_weight,
            data = df,
            nest = TRUE)
})
```

# Function for Logistic models for associations between cancer history and alcohol consumption
```{r}
run_svyglm_models <- function(outcome_var, exposure_var, survey_designs, adjust = FALSE, model_label = NULL, exclude_sex = FALSE) {
  covariates <- c("age_cat", "sex", "race_ethnicity", "insurance", "educ", "smoke", "marital", "income", "persdoc")
  if (exclude_sex) {
    covariates <- setdiff(covariates, "sex")
  }

  if (adjust) {
    formula_text <- paste0(outcome_var, " ~ ", exposure_var, " + ", paste(covariates, collapse = " + "))
  } else {
    formula_text <- paste0(outcome_var, " ~ ", exposure_var)
  }

  model_formula <- as.formula(formula_text)

  models_svy <- lapply(survey_designs, function(design) {
    svyglm(model_formula, family = quasibinomial(), design = design)
  })

  pooled <- pool(as.mira(models_svy))
  summary_out <- summary(pooled, exponentiate = TRUE, conf.int = TRUE)
  summary_out$model <- model_label
  return(as.data.frame(summary_out))
}
```

# run function for cancer_surv
```{r}
# drinker30
# Unadjusted models
unadj_drinker30 <- run_svyglm_models(
  outcome_var = "drinker30",
  exposure_var = "cancer_surv",
  survey_designs = survey_designs,
  adjust = FALSE,
  model_label = "Unadjusted current drinking"
)

# Adjusted models
adj_drinker30 <- run_svyglm_models(
  outcome_var = "drinker30",
  exposure_var = "cancer_surv",
  survey_designs = survey_designs,
  adjust = TRUE,
  model_label = "Adjusted current drinking"
)

# heavy
unadj_heavy<- run_svyglm_models(
  outcome_var = "heavy",
  exposure_var = "cancer_surv",
  survey_designs = survey_designs,
  adjust = FALSE,
  model_label = "Unadjusted heavy drinking"
)

# Adjusted models
adj_heavy <- run_svyglm_models(
  outcome_var = "heavy",
  exposure_var = "cancer_surv",
  survey_designs = survey_designs,
  adjust = TRUE,
  model_label = "Adjusted heavy drinking"
)

# binge
unadj_binge <- run_svyglm_models(
  outcome_var = "binge",
  exposure_var = "cancer_surv",
  survey_designs = survey_designs,
  adjust = FALSE,
  model_label = "Unadjusted binge drinking"
)

# Adjusted models
adj_binge <- run_svyglm_models(
  outcome_var = "binge",
  exposure_var = "cancer_surv",
  survey_designs = survey_designs,
  adjust = TRUE,
  model_label = "Adjusted binge drinking"
)

# bind all results for drinker 30
table2a <- rbind(unadj_drinker30, adj_drinker30, unadj_heavy, adj_heavy, unadj_binge, adj_binge)
```

# run function for alcohol-related cancers
```{r}
# drinker30
# Unadjusted models
unadj_drinker30 <- run_svyglm_models(
  outcome_var = "drinker30",
  exposure_var = "alcohol_related2",
  survey_designs = survey_designs,
  adjust = FALSE,
  model_label = "Unadjusted current drinking alcohol_related2"
)

# Adjusted models
adj_drinker30 <- run_svyglm_models(
  outcome_var = "drinker30",
  exposure_var = "alcohol_related2",
  survey_designs = survey_designs,
  adjust = TRUE,
  model_label = "Adjusted current drinking alcohol_related2"
)

# heavy
unadj_heavy<- run_svyglm_models(
  outcome_var = "heavy",
  exposure_var = "alcohol_related2",
  survey_designs = survey_designs,
  adjust = FALSE,
  model_label = "Unadjusted heavy drinking alcohol_related2"
)

# Adjusted models
adj_heavy <- run_svyglm_models(
  outcome_var = "heavy",
  exposure_var = "alcohol_related2",
  survey_designs = survey_designs,
  adjust = TRUE,
  model_label = "Adjusted heavy drinking alcohol_related2"
)

# binge
unadj_binge <- run_svyglm_models(
  outcome_var = "binge",
  exposure_var = "alcohol_related2",
  survey_designs = survey_designs,
  adjust = FALSE,
  model_label = "Unadjusted binge drinking alcohol_related2"
)

# Adjusted models
adj_binge <- run_svyglm_models(
  outcome_var = "binge",
  exposure_var = "alcohol_related2",
  survey_designs = survey_designs,
  adjust = TRUE,
  model_label = "Adjusted binge drinking alcohol_related2"
)

# bind all results for alcohol_related2
table2b <- rbind(unadj_drinker30, adj_drinker30, unadj_heavy, adj_heavy, unadj_binge, adj_binge)
```

# combine tables 2a and 2b and clean up
```{r}
table2 <- rbind(table2a, table2b)

table2 <- table2 %>%
  filter(term %in% c("cancer_survReported cancer", "alcohol_related2Alcohol related", "alcohol_related2Not alcohol related"))

# delete variable names from value
table2$term <- str_extract(table2$term, "[A-Z].*")

# create variable with OR and 95% CI
table2$`OR (95% CI)` <- sprintf("%.2f (%.2f to %.2f)", table2$estimate, table2$`2.5 %`,table2$`97.5 %`)

# select columns
table2 <-table2 %>%
  select(-c(2:10))

table2_full <- rbind(table2a, table2b)
```


# function to run cancer type analyses for plotting
```{r}
run_svyglm_by_cancer_type <- function(outcome_var, exposure_var, imputed_data_list, model_label) {
  # Get unique cancer types, excluding "None"
  all_cancer_types <- unique(unlist(lapply(imputed_data_list, function(df) unique(df$can_type2))))
  cancer_types <- setdiff(all_cancer_types, "None")

  # Define sex-specific exclusion rules
  female_only <- c("Breast", "Cervix/Cervical", "Uterus/Uterine", "Ovary/Ovarian")
  male_only   <- c("Testis/Testicular", "Prostate")

  # Loop over cancer types
  results_list <- lapply(seq_along(cancer_types), function(i) {
    cancer <- cancer_types[i]

    message(sprintf("Running model %d of %d: %s", i, length(cancer_types), cancer))

    # Apply cancer- and sex-specific filtering
    filtered_data_list <- lapply(imputed_data_list, function(df) {
      df_filtered <- df %>% filter(can_type2 %in% c("None", cancer))

      # Correct sex restriction using ==
      if (cancer %in% female_only) {
        df_filtered <- df_filtered %>% filter(sex == "Female")
      } else if (cancer %in% male_only) {
        df_filtered <- df_filtered %>% filter(sex == "Male")
      }

      return(df_filtered)
    })

    # Create survey designs
    survey_designs <- lapply(filtered_data_list, function(df) {
      svydesign(id = ~`_PSU`,
                strata = ~strata,
                weights = ~adj_weight,
                data = df,
                nest = TRUE)
    })

    # xclude sex from model formula if needed
    exclude_sex <- cancer %in% c(female_only, male_only)

    # Run adjusted model
    model_output <- run_svyglm_models(
      outcome_var = outcome_var,
      exposure_var = exposure_var,
      survey_designs = survey_designs,
      adjust = TRUE,
      model_label = paste0(model_label, ": ", cancer),
      exclude_sex = exclude_sex  
    )

    model_output$cancer_type <- cancer
    return(model_output)
  })

  bind_rows(results_list)
}
```

# run function for current drinking, binge drinking, heavy drinking
```{r}
adjusted_results_by_cancer <- run_svyglm_by_cancer_type(
  outcome_var = "drinker30",
  exposure_var = "cancer_surv",
  imputed_data_list = combined_imputed_data,
  model_label = "adjusted cancer type current"
)


# limit to cancers with at least 50 binge drinker cases
# Define the cancer types you want to keep
cancers_to_keep <- c(
  "None", "Bladder", "Hematologic", "Breast", "Cervix/Cervical", 
  "Colon and rectal", "Melanoma", "Prostate", 
  "Skin (non-melanoma)/Skin (don’t know what kind)", "Other"
)

# Filter each dataset in the list
combined_imputed_data_filtered <- lapply(combined_imputed_data, function(df) {
  df %>% filter(can_type2 %in% cancers_to_keep)
})

combined_imputed_data_binge 
adjusted_results_by_cancer_binge <- run_svyglm_by_cancer_type(
  outcome_var = "binge",
  exposure_var = "cancer_surv",
  imputed_data_list = combined_imputed_data,
  model_label = "adjusted cancer type binge"
)

# limit to cancers with sufficient cases
adjusted_results_by_cancer_heavy <- run_svyglm_by_cancer_type(
  outcome_var = "heavy",
  exposure_var = "cancer_surv",
  imputed_data_list = combined_imputed_data,
  model_label = "adjusted cancer type heavy"
)

df<- combined_imputed_data[[1]]


table(df$can_type2, df$drinker30)
table(df$can_type2, df$binge)
table(df$can_type2, df$heavy)

```

# confirm results are correct for current drinking for example prostate cancer
```{r}
# 1. Filter each imputed dataset to include only Breast and None, and only Females
prostate_data_list <- lapply(combined_imputed_data, function(df) {
  df %>%
    filter(can_type2 %in% c("None", "Prostate") & sex == "Male")
})

# 2. Create survey designs for each imputed dataset
prostate_designs <- lapply(prostate_data_list, function(df) {
  svydesign(
    id = ~`_PSU`,
    strata = ~strata,
    weights = ~adj_weight,
    data = df,
    nest = TRUE
  )
})

# 3. Define covariates (excluding sex)
covariates <- c("age_cat", "race_ethnicity", "insurance", "educ",
                "smoke", "marital", "income", "persdoc")

# 4. Build formula
formula_text <- paste0("drinker30 ~ cancer_surv + ", paste(covariates, collapse = " + "))
model_formula <- as.formula(formula_text)

# 5. Fit model on each imputed dataset
prostate_models <- lapply(prostate_designs, function(design) {
  svyglm(model_formula, design = design, family = quasibinomial())
})

# 6. Pool results
library(mitools)
pooled <- pool(as.mira(prostate_models))
summary_out <- summary(pooled, exponentiate = TRUE, conf.int = TRUE)

# 7. Add label
summary_out$model <- "Prostate cancer: adjusted, males only"
summary_out$cancer_type <- "Prostate"

# 8. View results
summary_out


# Count number with prostate cancer in each imputed dataset
n_prostate <- sapply(prostate_data_list, function(df) {
  sum(df$can_type2 == "Prostate")
})

# View counts
n_prostate[[1]] # correct
mean(n_prostate)  # average across imputations
range(n_prostate) # min and max for context
```

# Clean up for plotting and plot drinker30
```{r}
cancer_results_for_plotting <-adjusted_results_by_cancer  %>%
  filter(term %in% c("cancer_survReported cancer"))

# delete variable names from value
cancer_results_for_plotting $term <- str_extract(cancer_results_for_plotting $term, "[A-Z].*")

# reorder cancer_type based on OR
cancer_results_for_plotting$cancer_type <- factor(cancer_results_for_plotting$cancer_type, levels = cancer_results_for_plotting$cancer_type[order(cancer_results_for_plotting$estimate)])


cancer_results_for_plotting <- cancer_results_for_plotting %>%
  mutate(ci_crosses_1 = if_else(conf.low <= 1 & conf.high >= 1, "gray", "black"))

plot <- ggplot(cancer_results_for_plotting, aes(x = cancer_type, y = estimate, ymin = conf.low, ymax = conf.high)) +
  geom_pointrange(aes(color = ci_crosses_1)) +
  scale_color_manual(values = c("gray" = "gray", "black" = "black")) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "red") +
  coord_flip() +
  labs(
    x = "Cancer Type",
    y = "Odds Ratio (95% CI)",
    title = ""
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none") +
  theme_classic()

plot
```


# Clean up for plotting and plot binge
```{r}
cancer_results_for_plotting <-adjusted_results_by_cancer_binge  %>%
  filter(term %in% c("cancer_survReported cancer"))

# delete variable names from value
cancer_results_for_plotting $term <- str_extract(cancer_results_for_plotting $term, "[A-Z].*")

# reorder cancer_type based on OR
cancer_results_for_plotting$cancer_type <- factor(cancer_results_for_plotting$cancer_type, levels = cancer_results_for_plotting$cancer_type[order(cancer_results_for_plotting$estimate)])


cancer_results_for_plotting <- cancer_results_for_plotting %>%
  mutate(ci_crosses_1 = if_else(conf.low <= 1 & conf.high >= 1, "gray", "black"))

plot_binge <- ggplot(cancer_results_for_plotting, aes(x = cancer_type, y = estimate, ymin = conf.low, ymax = conf.high)) +
  geom_pointrange(aes(color = ci_crosses_1)) +
  scale_color_manual(values = c("gray" = "gray", "black" = "black")) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "red") +
  coord_flip() +
  labs(
    x = "Cancer Type",
    y = "Odds Ratio (95% CI)",
    title = ""
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none") +
  theme_classic()

plot_binge
```

# Need to run models eliminating those who are in current treatment
```{r}
# Create survey designs, excluding individuals in current treatment
options(survey.lonely.psu = "adjust")
survey_designs_ex <- lapply(combined_imputed_data, function(df) {
  df_filtered <- df[df$current_trt != "Current treatment", ]
  svydesign(id = ~`_PSU`,
            strata = ~strata,
            weights = ~adj_weight,
            data = df_filtered,
            nest = TRUE)
})
```

# how much sample is excluded?
```{r}
excluded_summary <- lapply(combined_imputed_data, function(df) {
  df <- df %>%
    mutate(excluded = if_else(current_trt == "Current treatment", 1, 0))

  # Total rows before exclusion
  unweighted_total <- nrow(df)

  # Basic exclusion counts
  unweighted_excluded <- sum(df$excluded == 1, na.rm = TRUE)
  unweighted_included <- sum(df$excluded == 0, na.rm = TRUE)
  unweighted_percent <- 100 * unweighted_excluded / unweighted_total

  # Subset for reported cancer only
  reported_cancer <- df %>% filter(cancer_surv == "Reported cancer")

  # Of those, how many are excluded?
  reported_cancer_total <- nrow(reported_cancer)
  reported_cancer_excluded <- sum(reported_cancer$current_trt == "Current treatment", na.rm = TRUE)

  # Survey design for full data
  design <- svydesign(id = ~`_PSU`,
                      strata = ~strata,
                      weights = ~adj_weight,
                      data = df,
                      nest = TRUE)

  weighted_excluded <- svymean(~excluded, design, na.rm = TRUE)[[1]] * 100

  data.frame(
    unweighted_total = unweighted_total,
    unweighted_excluded = unweighted_excluded,
    unweighted_included = unweighted_included,
    unweighted_percent = round(unweighted_percent, 2),
    weighted_percent = round(weighted_excluded, 2),
    reported_cancer_total = reported_cancer_total,
    reported_cancer_excluded = reported_cancer_excluded
  )
})

excluded_summary_df <- do.call(rbind, excluded_summary)
excluded_summary_df$imputation <- seq_along(combined_imputed_data)

# View results
excluded_summary_df$percent_reported_cancer_excluded <- (excluded_summary_df$reported_cancer_excluded/excluded_summary_df$reported_cancer_total)*100

excluded_summary_df

# how many in current treatment?
table(combined_imputed_data[[1]]$cancer_surv, combined_imputed_data[[1]]$current_trt) 
table(combined_imputed_data[[2]]$cancer_surv, combined_imputed_data[[2]]$current_trt)
table(combined_imputed_data[[3]]$cancer_surv, combined_imputed_data[[3]]$current_trt)
table(combined_imputed_data[[4]]$cancer_surv, combined_imputed_data[[4]]$current_trt)
table(combined_imputed_data[[5]]$cancer_surv, combined_imputed_data[[5]]$current_trt)
```

# Run unadjusted and adjusted models for those not currently in treatment
```{r}
# drinker30
# Unadjusted models
unadj_drinker30 <- run_svyglm_models(
  outcome_var = "drinker30",
  exposure_var = "cancer_surv",
  survey_designs = survey_designs_ex,
  adjust = FALSE,
  model_label = "Unadjusted current drinking"
)

# Adjusted models
adj_drinker30 <- run_svyglm_models(
  outcome_var = "drinker30",
  exposure_var = "cancer_surv",
  survey_designs = survey_designs_ex,
  adjust = TRUE,
  model_label = "Adjusted current drinking"
)

# heavy
unadj_heavy<- run_svyglm_models(
  outcome_var = "heavy",
  exposure_var = "cancer_surv",
  survey_designs = survey_designs_ex,
  adjust = FALSE,
  model_label = "Unadjusted heavy drinking"
)

# Adjusted models
adj_heavy <- run_svyglm_models(
  outcome_var = "heavy",
  exposure_var = "cancer_surv",
  survey_designs = survey_designs_ex,
  adjust = TRUE,
  model_label = "Adjusted heavy drinking"
)

# binge
unadj_binge <- run_svyglm_models(
  outcome_var = "binge",
  exposure_var = "cancer_surv",
  survey_designs = survey_designs_ex,
  adjust = FALSE,
  model_label = "Unadjusted binge drinking"
)

# Adjusted models
adj_binge <- run_svyglm_models(
  outcome_var = "binge",
  exposure_var = "cancer_surv",
  survey_designs = survey_designs_ex,
  adjust = TRUE,
  model_label = "Adjusted binge drinking"
)

# bind all results
table3a <- rbind(unadj_drinker30, adj_drinker30, unadj_heavy, adj_heavy, unadj_binge, adj_binge)
```


# run function for alcohol related for those not currently in treatment
```{r}
# drinker30
# Unadjusted models
unadj_drinker30 <- run_svyglm_models(
  outcome_var = "drinker30",
  exposure_var = "alcohol_related2",
  survey_designs = survey_designs_ex,
  adjust = FALSE,
  model_label = "Unadjusted current drinking alcohol_related2"
)

# Adjusted models
adj_drinker30 <- run_svyglm_models(
  outcome_var = "drinker30",
  exposure_var = "alcohol_related2",
  survey_designs = survey_designs_ex,
  adjust = TRUE,
  model_label = "Adjusted current drinking alcohol_related2"
)

# heavy
unadj_heavy<- run_svyglm_models(
  outcome_var = "heavy",
  exposure_var = "alcohol_related2",
  survey_designs = survey_designs_ex,
  adjust = FALSE,
  model_label = "Unadjusted heavy drinking alcohol_related2"
)

# Adjusted models
adj_heavy <- run_svyglm_models(
  outcome_var = "heavy",
  exposure_var = "alcohol_related2",
  survey_designs = survey_designs_ex,
  adjust = TRUE,
  model_label = "Adjusted heavy drinking alcohol_related2"
)

# binge
unadj_binge <- run_svyglm_models(
  outcome_var = "binge",
  exposure_var = "alcohol_related2",
  survey_designs = survey_designs_ex,
  adjust = FALSE,
  model_label = "Unadjusted binge drinking alcohol_related2"
)

# Adjusted models
adj_binge <- run_svyglm_models(
  outcome_var = "binge",
  exposure_var = "alcohol_related2",
  survey_designs = survey_designs_ex,
  adjust = TRUE,
  model_label = "Adjusted binge drinking alcohol_related2"
)

# bind all results
table3b <- rbind(unadj_drinker30, adj_drinker30, unadj_heavy, adj_heavy, unadj_binge, adj_binge)
```

# combine table 3a and 3b and clean up
```{r}
table3 <- rbind(table3a, table3b)

table3 <- table3 %>%
  filter(term %in% c("cancer_survReported cancer", "alcohol_related2Alcohol related", "alcohol_related2Not alcohol related"))

# delete variable names from value
table3$term <- str_extract(table3$term, "[A-Z].*")

# create variable with OR and 95% CI
table3$`OR (95% CI)` <- sprintf("%.2f (%.2f to %.2f)", table3$estimate, table3$`2.5 %`,table3$`97.5 %`)

# select columns
table3 <-table3 %>%
  select(-c(2:10))


table3_full <- rbind(table3a, table3b)
```

# get n's
```{r}
sapply(survey_designs, function(design) {
  nrow(design$variables)
})

sapply(survey_designs_ex, function(design) {
  nrow(design$variables)
})
```

# need to run by cancer type for plotting excluding those in current treatment
```{r}
# Filter each imputed dataset to exclude people in current treatment
filtered_imputed_data <- lapply(combined_imputed_data, function(df) {
  df %>% filter(current_trt != "Current treatment")
})

adjusted_results_by_cancer_ex <- run_svyglm_by_cancer_type(
  outcome_var = "drinker30",
  exposure_var = "cancer_surv",
  imputed_data_list =filtered_imputed_data ,
  model_label = "adjusted cancer type"
 )
```

# Get n for Table 3 title
```{r}
# Count n in each imputed dataset
n_per_dataset <- sapply(filtered_imputed_data, nrow)

n_per_dataset
```

# Clean up for plotting and plot
```{r}
# Get the desired cancer_type order from the original results
cancer_results_for_plotting <- adjusted_results_by_cancer %>%
  filter(term %in% c("cancer_survReported cancer"))

# Clean up term labels
cancer_results_for_plotting$term <- str_extract(cancer_results_for_plotting$term, "[A-Z].*")

# Set factor order based on estimate 
cancer_results_for_plotting$cancer_type <- factor(
  cancer_results_for_plotting$cancer_type,
  levels = cancer_results_for_plotting$cancer_type[order(cancer_results_for_plotting$estimate)]
)

# Save the order 
ordered_cancer_levels <- levels(cancer_results_for_plotting$cancer_type)

# Apply the same order to the "ex" results
cancer_results_for_plotting_ex <- adjusted_results_by_cancer_ex %>%
  filter(term %in% c("cancer_survReported cancer"))

# Clean up term labels
cancer_results_for_plotting_ex$term <- str_extract(cancer_results_for_plotting_ex$term, "[A-Z].*")

# Apply the saved ordering from the first plot
cancer_results_for_plotting_ex <- cancer_results_for_plotting_ex %>%
  mutate(
    cancer_type = factor(cancer_type, levels = ordered_cancer_levels),
    ci_crosses_1 = if_else(conf.low <= 1 & conf.high >= 1, "gray", "black")
  )

# Step 3: Plot the "ex" model with the same ordering
plot_ex <- ggplot(cancer_results_for_plotting_ex, aes(x = cancer_type, y = estimate, ymin = conf.low, ymax = conf.high)) +
  geom_pointrange(aes(color = ci_crosses_1)) +
  scale_color_manual(values = c("gray" = "gray", "black" = "black")) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "red") +
  coord_flip() +
  labs(
    x = "Cancer Type",
    y = "Odds Ratio (95% CI)",
    title = ""
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none") +
  theme_classic()

plot_ex
```

# Export forest plots as figure 2
```{r}
plot <- plot +
  theme_classic(base_size = 14) +
  theme(
    legend.position = "none",
    plot.tag = element_text(face = "bold", size = 14),
    plot.tag.position = c(0.5, 1.0)  # move tag left and up
  )

plot_ex <- plot_ex +
  theme_classic(base_size = 14) +
  theme(
    legend.position = "none",
    plot.tag = element_text(face = "bold", size = 14),
    plot.tag.position = c(0.5, 1.0)
  ) +
  xlab(NULL)

# Combine with bold A and B panel tags
combined_plot <- plot + plot_ex +
  plot_annotation(tag_levels = 'A', tag_prefix = "", tag_suffix = "")

combined_plot

ggsave("R_output/Figure 2.pdf", plot = combined_plot, width = 14, height = 6, units = "in")
```

# Create Supplementary Table 4. Cancer types in BRFSS participants in 2022 and 2023 (imputed data).
```{r}


# Function to summarize by cancer type
summarize_cancer_data <- function(df, exclude_current = FALSE) {
  if (exclude_current) {
    df <- df %>% filter(current_trt != "Current treatment")
  }

  # Count N for each cancer type
  counts <- df %>%
    count(can_type2, name = "N")
  
  # Total for % calculation (exclude 'None' from denominator)
  total_pct <- df %>%
    filter(can_type2 != "None") %>%
    nrow()
  
  # Add percent column, set to NA for 'None'
  counts <- counts %>%
    mutate(
      percent = ifelse(can_type2 == "None", NA, 100 * N / total_pct)
    )
  
  return(counts)
}

# Apply to each imputed dataset in the list
summaries_incl <- map(combined_imputed_data, summarize_cancer_data)
summaries_excl <- map(combined_imputed_data, ~summarize_cancer_data(.x, exclude_current = TRUE))

# Function to aggregate summary stats across imputations
aggregate_summaries <- function(summary_list) {
  bind_rows(summary_list, .id = "imp") %>%
    mutate(can_type2 = as.character(can_type2)) %>%  # Convert to character
    group_by(can_type2) %>%
    summarise(
      mean_N = round(mean(N)),
      range_N = paste0("(", min(N), "-", max(N), ")"),
      mean_percent = round(mean(percent, na.rm = TRUE), 1),
      range_percent = paste0("(", round(min(percent, na.rm = TRUE), 1), "-", round(max(percent, na.rm = TRUE), 1), ")"),
      .groups = "drop"
    ) %>%
    mutate(
      `Mean N (Range)` = paste0(mean_N, " ", range_N),
      `Mean % of Total (Range)` = paste0(mean_percent, "% ", range_percent)
    ) %>%
    select(`Cancer Type` = can_type2, `Mean N (Range)`, `Mean % of Total (Range)`) %>%
    arrange(desc(`Cancer Type` == "None"), `Cancer Type`)
 # <- This ensures alphabetical order
}

# Create final tables
final_table_incl <- aggregate_summaries(summaries_incl)
final_table_excl <- aggregate_summaries(summaries_excl)

# View results
print("Including all cases:")
print(final_table_incl)

print("Excluding those on current treatment:")
print(final_table_excl)

final_table <- cbind(final_table_incl, final_table_excl)
write_xlsx(final_table, "R_output/Supplementary Table 4.xlsx")
```

# Export all results
```{r}
all_results_named <- list(
  "Table 2 (Clean)" = table2,
  "Table 2 (Full)" = table2_full,
  "Table 3 (Clean)" = table3,
  "Table 3 (Full)" = table3_full,
  "Adjusted Cancer Results" = adjusted_results_by_cancer,
  "Adjusted Cancer Results (Excl. Tx)" = adjusted_results_by_cancer_ex
)

write_xlsx(all_results_named, "R_output/all_results.xlsx")
```

# Results: Last paragraph comparing the point estimates shifts between adjusted cancer results including and excluding those in current cancer treatment
```{r}
# 1. Clean the dataframes to remove adjustment variable rows
adjusted_results_by_cancer_clean <- adjusted_results_by_cancer %>%
  filter(term %in% c("cancer_survReported cancer"))

# delete variable names from value
adjusted_results_by_cancer_clean$term <- str_extract(adjusted_results_by_cancer_clean$term, "[A-Z].*")

# select columns
adjusted_results_by_cancer_clean <- adjusted_results_by_cancer_clean %>%
  select(-c(3:11)) %>%
  mutate(exclusion = "No")%>%
  arrange(cancer_type)  # Sort alphabetically by cancer_type2

adjusted_results_by_cancer_clean_ex <- adjusted_results_by_cancer_ex %>%
  filter(term %in% c("cancer_survReported cancer"))

# delete variable names from value
adjusted_results_by_cancer_clean_ex$term <- str_extract(adjusted_results_by_cancer_clean_ex$term, "[A-Z].*")

# select columns
adjusted_results_by_cancer_clean_ex <- adjusted_results_by_cancer_clean_ex %>%
  select(-c(3:11)) %>%
  mutate(exclusion = "Yes") %>%
  rename(term2 = term,
         estimate2 = estimate,
         cancer_type2 = cancer_type,
         exclusion2 = exclusion
         ) %>%
  arrange(cancer_type2)  # Sort alphabetically by cancer_type2

comp_data <- cbind(adjusted_results_by_cancer_clean, adjusted_results_by_cancer_clean_ex)



comp_data <-comp_data %>%
  mutate(difference = estimate - estimate2) %>%
  mutate(closer = case_when(estimate <1 & difference <0 ~ "Closer",
                            estimate <1 & difference >0 ~ "Further",
                            estimate >1 & difference <0 ~ "Further",
                            estimate >1 & difference >0 ~ "Closer"))
```

# save workspace
```{r}
save.image(file = "BRFSS ALCOHOL TRENDS.RData")
```

